\begin{algorithm}
	\caption{Byzantine Generalized Paxos - Proposer p}
	\begin{algorithmic}[1]
		
		\Function{propose}{\textit{C}}
		\If{fast\_ballot}
		\State \Call{send}{$fast, C$} to Acceptors;
		\Else
		\State \Call{send}{\textit{propose, C}} to Leader;
		\EndIf
		\EndFunction
		
	\end{algorithmic}
\end{algorithm}

\begin{algorithm}
	\caption{Byzantine Generalized Paxos - Process p}
	\textbf{Local variables:} $suspicions = \bot,\ new\_view = \bot,\ leader = \bot,\ view = 0$
	\begin{algorithmic}[1]
		
		\State \textbf{upon} \textit{suspect\_leader} \textbf{do} 
		\State \hspace{\algorithmicindent} \textbf{if} $suspicions[p] \neq true$ \textbf{then}
		\State\hspace{\algorithmicindent}\hspace{\algorithmicindent}$suspicions[p] = true$;
		\State\hspace{\algorithmicindent}\hspace{\algorithmicindent}$ digest = hash(\langle suspicion, view \rangle) $;
		\State\hspace{\algorithmicindent}\hspace{\algorithmicindent}\Call{send}{$suspicion, view, digest_{\sigma_p}$};	
		\State
		
		\State \textbf{upon} \textit{receive($suspicion, view_i, digest_{\sigma_i}$)} from process $p_i$ \textbf{do} 
		\State \hspace{\algorithmicindent} \textbf{if} $view_i \neq view$ \textbf{then}
		\State \hspace{\algorithmicindent}\hspace{\algorithmicindent} \textbf{return};
		\State
		\State \hspace{\algorithmicindent} $suspicions[p_i] = digest_{\sigma_i}$;
		\State \hspace{\algorithmicindent} \textbf{if} $\#(suspicions) > f$ and $new\_view[p] = \bot$ \textbf{then}
		\State\hspace{\algorithmicindent}\hspace{\algorithmicindent} $new\_view[p] = \langle last\_bal,\ last\_val \rangle$;
		\State\hspace{\algorithmicindent}\hspace{\algorithmicindent}  \Call{send}{$view\_change, view+1, last\_bal, last\_val, suspicions$};
		\State
		
		\State\textbf{upon} \textit{receive($view\_change, view_i, last\_bal_i, last\_val_i, suspicions$)} from process $p_i$ \textbf{do} 
		\State\hspace{\algorithmicindent} \textbf{if} \Call{!verifySignatures}{$suspicions$} \textbf{or} $view_i \leq view$ \textbf{then}
		\State\hspace{\algorithmicindent}\hspace{\algorithmicindent}\textbf{return};
		\State
		\State\hspace{\algorithmicindent} $new\_view[view_i][p_i] = \langle last\_bal_i,\ last\_val_i \rangle$;
		\State\hspace{\algorithmicindent} \textbf{if} $new\_view[view_i][p] = \bot$ \textbf{then}
		\State\hspace{\algorithmicindent}\hspace{\algorithmicindent} $new\_view[view_i][p] = \langle last\_bal,\ last\_val \rangle$;
		\State\hspace{\algorithmicindent}\hspace{\algorithmicindent}  \Call{send}{$view\_change, view_i, last\_bal, last\_val, suspicions_{\sigma_i}$};
		\State
		\State\hspace{\algorithmicindent} \textbf{if} $\#(new\_view[view_i]) > 2f$ \textbf{then}
		\State\hspace{\algorithmicindent}\hspace{\algorithmicindent} $view = view_i$;
		\State\hspace{\algorithmicindent}\hspace{\algorithmicindent} $leader = n\ mod\ view$;
		\State\hspace{\algorithmicindent}\hspace{\algorithmicindent} $suspicions = \bot$;
		\State\hspace{\algorithmicindent}\hspace{\algorithmicindent} $new\_view = \bot$;

		
		\State
		\Function{is\_prefix}{$new\_sequence, old\_sequence$}
		\If {$\lVert old\_sequence \rVert > \lVert new\_sequence \rVert$}
		\State \textbf{return} \textit{false};
		\EndIf
		
		\State
		\item[] outer:	
		\State \textbf{for} $c_{old}$ in $old\_sequence$ \textbf{do}
		\State \hspace{\algorithmicindent} \textbf{for} $c_{new}$ in $new\_sequence$ \textbf{do}
		\State\hspace{\algorithmicindent}\hspace{\algorithmicindent} \textbf{if} $c_{old} = c_{new}$ \textbf{then}
		\State \hspace{\algorithmicindent}\hspace{\algorithmicindent}\hspace{\algorithmicindent} \textbf{continue} \textit{outer};
		
		\State \hspace{\algorithmicindent}\hspace{\algorithmicindent} \textbf{else if} !\Call{are\_commutative}{$c_{old}, c_{new}$} \textbf{then}
		\State\hspace{\algorithmicindent}\hspace{\algorithmicindent}\hspace{\algorithmicindent} \textbf{return} \textit{false};
		\State \hspace{\algorithmicindent}\textbf{end for}
		\State \hspace{\algorithmicindent}\textbf{return} \textit{false};
		\State \textbf{end for}
		\State
		\State \textbf{return} \textit{true};
		\EndFunction
	\end{algorithmic}
\end{algorithm}

\begin{algorithm}
	\caption{Byzantine Generalized Paxos - Leader l}
	\textbf{Local variables:} $ballot_l = 0,\ maxTried_l = \bot,\ C_l = \bot,\ messages = \bot$
	\begin{algorithmic}[1]
		\State \textbf{upon} \textit{receive(propose, C)} from proposer $p_i$ \textbf{do} 
		\State \hspace{\algorithmicindent} $C_l = C$;
		\State \hspace{\algorithmicindent} \Call{phase\_1a}{$ $};
		\State
		\State \textbf{upon} \textit{receive($p1b, m, bal_a, val_a, digest_{\sigma_p}$)} from acceptor $a_i$ \textbf{do}
		\State\hspace{\algorithmicindent} $digest = hash(\langle bal_a, val_a \rangle)$;
		\State \hspace{\algorithmicindent} \textbf{if} $m = ballot_l$ and $pubkey_p(digest_{\sigma_p}) = digest$ \textbf{then}
		\State\hspace{\algorithmicindent}\hspace{\algorithmicindent}\hspace{\algorithmicindent}  $messages[ballot_l][a_i] = val_a$;
		\State \hspace{\algorithmicindent} \textbf{if} $\#(messages) \geq \lceil \frac{N+f}{2}\rceil$ \textbf{then} 
		\State \hspace{\algorithmicindent}\hspace{\algorithmicindent} \Call{phase\_2a}{$ $};
		\State
		%\item[] % unnumbered empty line
		\Function{phase\_1a}{$ $}
		\State $ballot_l \mathrel{+{=}} 1$;
		\State \Call{send}{$p1a, ballot_l$} to Acceptors;
		\EndFunction
		
		\State
		\Function{phase\_2a}{$ $}
		\State $maxTried_l$ = \Call{proved\_safe}{$ballot_l$};
		\State $maxTried_l = maxTried_l \bullet C_l$;
		\State $digest = hash(\langle ballot_l, maxTried_l \rangle)$;
		\State \Call{send}{$p2a,ballot_l, maxTried_l, digest_{\sigma_l}$} to Acceptors;
		\EndFunction
		
		\State
		\Function{proved\_safe}{$ballot$}
		\State $maxTried = \bot$;
		\State \textbf{for} $val$ in $message[ballot]$ \textbf{do}
		\State \hspace{\algorithmicindent} \textbf{if} $maxTried = \bot$ or $\Call{is\_prefix}{val, maxTried}$ \textbf{then}
		\State\hspace{\algorithmicindent}\hspace{\algorithmicindent} $maxTried = val$;
		\State \textbf{end for}
		\State \textbf{return} $maxTried$;
		\EndFunction
		
		\iffalse \State
		\Function{proved\_safe}{Q, m}
		\State $k = max(i\ |\ (i < m) \wedge (\exists a \in Q :\ val_a[i]\ \neq null))$;
		\State $RS = \{R \in k$-$quorum\ |\ \forall a \in R \cap Q : val_a[k] \neq null\}$;
		\State $\gamma(R) = \sqcap \{v_a[k]\ |\ a \in Q \cap R \}$;
		\State $\Gamma = \{\gamma(R)\ |\ R \in RS \}$;
		\State
		\If{$RS = \varnothing$}
		\State \textbf{return} $\{val_a[k]\ |\ (a \in Q) \wedge (val_a[k] \neq null)\}$;
		\Else
		\State \textbf{return} $\sqcup \Gamma$;
		\EndIf
		\EndFunction
		\fi
		
	\end{algorithmic}
\end{algorithm}

\begin{algorithm}
	\caption{Byzantine Generalized Paxos - Acceptor a}
	\textbf{Local variables: } $bal_a = 0,\ val_a = \bot,\ proof = \bot$ 
	\begin{algorithmic}[1]
		
		\State \textbf{upon} \textit{receive(fast, val)} from proposer \textit{p} \textbf{do}
		\State \hspace{\algorithmicindent} \Call{phase\_2b\_fast}{$val$};
		
		\State
		\State \textbf{upon} \textit{receive(p1a, ballot)} from leader \textit{l} \textbf{do}
		\State \hspace{\algorithmicindent} \Call{phase\_1b}{$ballot, l$};
		
		\State
		\State \textbf{upon} \textit{receive(p2a, ballot, value, $digest_{\sigma_l}$)} from leader \textit{l} \textbf{do}
		\State \hspace{\algorithmicindent} \Call{phase\_2b\_classic}{$ballot, value, digest_{\sigma_l}$}; 
		
		\State
		\Function{phase\_1b}{$ballot, l$}
		\If {$bal_a < ballot$}
		\State \Call{send}{$p1b, ballot, bal_a, val_a, proof$} to leader l;
		\State $bal_a = ballot$;
		\EndIf
		\EndFunction
	
		\State
		\Function{phase\_2b\_classic}{$ballot, value, digest_{\sigma_l}$}
		\State $k = max(i\ |\ (i < ballot) \wedge (\exists a \in Q :\ val_a[i]\ \neq null))$;
		\If {$ballot \geq k$ and $\Call{is\_prefix}{v, val_a}$}
		\State $val_a = value$;
		\State $proof = digest_{\sigma_l}$;
		\State \Call{send}{$p2b, bal_a, val_a, digest_{\sigma_l}$} to learners;
		\EndIf
		\EndFunction
		
		\State
		\Function{phase\_2b\_fast}{$v$}
		\State $k = max(i\ |\ (i < m) \wedge (\exists a \in Q :\ val_a[i]\ \neq null))$;
		\If {$bal_a == k$}
		\State $val_a = val_a \bullet v$;
		\State \Call{send}{$p2b, bal_a, val_a$} to learners;
		\EndIf
		\EndFunction
	\end{algorithmic}
\end{algorithm}

\begin{algorithm}
	\caption{Byzantine Generalized Paxos - Learner l}
	\textbf{Local variables: } $learned = \bot, messages = \bot,\ verificationRequests = \bot,\ ackMessages = \bot,\ ack\_values = \bot$ 
	\begin{algorithmic}[1]
		\State \textbf{upon} \textit{receive($p2b, bal, val, [digest_{\sigma_l}]$)} from acceptor $a_i$ \textbf{do}
		\State \hspace{\algorithmicindent} $messages[bal][a_i] = val$;
		\State \hspace{\algorithmicindent} \textbf{if} $fast\_ballot$ and $\#(messages[bal]) \geq N-E$ \textbf{then}
		\State\hspace{\algorithmicindent}\hspace{\algorithmicindent} \Call{send}{$VERIFY, bal, val$} to learners;
		\State \hspace{\algorithmicindent} \textbf{else if} $classic\_ballot$ and $\#(messages[bal]) \geq N-F$
		\State \hspace{\algorithmicindent} \hspace{\algorithmicindent} $learned = learned \sqcup val$;
		
		\State 
		\State \textbf{upon} \textit{receive(VERIFY, ballot, value)} from learner \textit{l} \textbf{do}
		\State \hspace{\algorithmicindent}\textbf{if} $\Call{conflict}{value, ack\_values}$ \textbf{then}
		\State\hspace{\algorithmicindent}\hspace{\algorithmicindent}\textbf{return};
		\State
		\State\hspace{\algorithmicindent}$verificationRequests[ballot][value][a] = true$;
		\State\hspace{\algorithmicindent}\textbf{if} $\#(verificationRequests[ballot][value]) > f$ \textbf{then}
		\State\hspace{\algorithmicindent} \hspace{\algorithmicindent}	$ack\_values[ballot] = ack\_values[ballot] \bullet value$;
		\State \hspace{\algorithmicindent} \hspace{\algorithmicindent} \Call{send}{$ACK, ballot, value$} to learners;
		
		\State 
		\State \textbf{upon} \textit{receive(ACK, ballot, value)} from learner \textit{l} \textbf{do}
		\State \hspace{\algorithmicindent}\textbf{if} $ballot = bal_a$ \textbf{then}
		\State \hspace{\algorithmicindent}\hspace{\algorithmicindent} $ackMessages[bal_a][value][a] = true$;
		\State \hspace{\algorithmicindent}\hspace{\algorithmicindent} \textbf{if} $\#(ackMessages[bal_a][value]) > 2f$ \textbf{then}
		\State\hspace{\algorithmicindent}\hspace{\algorithmicindent} \hspace{\algorithmicindent} $learned = learned \bullet val$;
		
	\end{algorithmic}
\end{algorithm}
